##############################################
# Dujiao-Next 完整部署 Docker Compose 文件
# 包含: 后端API + 管理后台 + 用户前端 + Redis
##############################################

services:
  # ============================
  # 1. Redis 缓存 & 队列
  # ============================
  redis:
    image: redis:7-alpine
    container_name: dujiao-redis
    restart: unless-stopped
    # ports:
    #   - "6379:6379"   # Redis 也不对外暴露，仅内部使用
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5
    networks:
      - dujiao-net

  # ============================
  # 2. 后端 API 服务 (Go)
  # ============================
  api:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: dujiao-api
    restart: unless-stopped
    # API 端口不对外暴露，仅通过前端 Nginx 反向代理访问
    # ports:
    #   - "9090:9090"
    volumes:
      - ./config.yml:/app/config.yml:ro # 配置文件（只读挂载）
      - api_db:/app/db # SQLite 数据库持久化
      - api_uploads:/app/uploads # 上传文件持久化
      - api_logs:/app/logs # 日志持久化
    depends_on:
      redis:
        condition: service_healthy
    healthcheck:
      test:
        ["CMD", "wget", "-q", "-O", "/dev/null", "http://localhost:9090/health"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s
    networks:
      - dujiao-net

  # ============================
  # 3. 管理后台前端 (Vue 3)
  # ============================
  admin:
    build:
      context: ./admin
      dockerfile: Dockerfile
    container_name: dujiao-admin
    restart: unless-stopped
    ports:
      - "9091:80"
    depends_on:
      api:
        condition: service_healthy
    networks:
      - dujiao-net

  # ============================
  # 4. 用户前端 (Vue 3)
  # ============================
  user:
    build:
      context: ./user
      dockerfile: Dockerfile
    container_name: dujiao-user
    restart: unless-stopped
    ports:
      - "9092:80"
    depends_on:
      api:
        condition: service_healthy
    networks:
      - dujiao-net

  # ============================
  # 5. BEpusdt 虚拟货币支付网关
  # ============================
  # ℹ️ 如果服务器上已经运行了 BEpusdt，无需启用以下服务，
  #    配置支付通道时网关地址填写: http://服务器内网IP:端口/ 或 http://実机公网IP:端口/
  #
  # 如果需要由 Docker Compose 统一管理，取消以下注释即可：
  # bepusdt:
  #   image: v03413/bepusdt:latest
  #   container_name: dujiao-bepusdt
  #   restart: unless-stopped
  #   ports:
  #     - "9990:8080"
  #   volumes:
  #     - bepusdt_data:/var/lib/bepusdt
  #   networks:
  #     - dujiao-net

# ============================
# 持久化卷
# ============================
volumes:
  redis_data:
    driver: local
  api_db:
    driver: local
  api_uploads:
    driver: local
  api_logs:
    driver: local
  # bepusdt_data:   # 仅在启用 bepusdt 服务时需要
  #   driver: local

# ============================
# 网络
# ============================
networks:
  dujiao-net:
    driver: bridge
